<div class="row page-enter">
  <div class="col-3">
    {{> sidebar}}
  </div>

  <div class="col-9">
    <!-- ======= BREADCRUMB + HEADER ======= -->
    <div class="card border-0 shadow-sm mb-3 header-enter">
      <div class="card-body d-flex flex-wrap gap-3 justify-content-between align-items-center">
        <div>
          <nav class="small text-muted d-flex align-items-center gap-2 mb-1">
            <i class="bi bi-house-door"></i>
            <a class="text-decoration-none" href="/admin/categories">Admin</a>
            <span>/</span>
            <span class="fw-semibold">Categories</span>
          </nav>
          <h3 class="mb-0 fw-bold d-flex align-items-center gap-2">
            <span class="brand-dot"></span> Categories
            {{#if categories.length}}
              <span class="badge bg-light text-dark border">{{categories.length}} total</span>
            {{/if}}
          </h3>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="quickFilter" class="form-control" placeholder="Filter by name or slug…" aria-label="Filter categories by name or slug">
          </div>
          <a href="/admin/categories/new" class="btn btn-primary btn-lg btn-glow" data-bs-toggle="tooltip" data-bs-title="Create a new category">
            <i class="bi bi-plus-circle me-1"></i> New Category
          </a>
        </div>
      </div>
    </div>

    {{> flash}}

    {{#if categories.length}}
      <div class="table-responsive card border-0 shadow-sm table-enter">
        <table class="table table-hover align-middle mb-0" id="tblCategories">
          <thead class="table-light sticky-top z-1">
            <tr>
              <th style="width:72px">#</th>
              <th style="min-width:240px">Name</th>
              <th style="min-width:220px">Slug</th>
              <th style="min-width:220px">Parent</th>
              <th style="width:200px">Type</th>
              <th class="text-end" style="width:200px">Action</th>
            </tr>
          </thead>
          <tbody>
            {{#each categories}}
            <tr class="row-enter">
              <td>
                {{#if ../offset}}
                  {{inc (add ../offset @index)}}
                {{else}}
                  {{inc @index}}
                {{/if}}
              </td>

              <td class="text-truncate" style="max-width:360px;">
                <strong class="cell-name" data-text="{{this.name}}">{{this.name}}</strong>
              </td>

              <td class="text-truncate d-flex align-items-center" style="max-width:320px; gap:.5rem;">
                <code class="cell-slug" data-text="{{this.slug}}">{{this.slug}}</code>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary btn-copy-slug"
                        data-slug="{{this.slug}}"
                        title="Copy slug"
                        data-bs-toggle="tooltip"
                        aria-label="Copy slug {{this.slug}}">
                  <i class="bi bi-clipboard"></i>
                </button>
              </td>

              <td class="text-truncate" style="max-width:320px;">
                {{#if this.parent_name}}
                  <span class="badge bg-light text-dark border cell-parent" data-text="{{this.parent_name}}">{{this.parent_name}}</span>
                {{else}}
                  <span class="badge bg-secondary">None</span>
                {{/if}}
              </td>

              <td>
                {{#if this.parent_id}}
                  <span class="badge bg-success-subtle text-success border border-success-subtle">Leaf</span>
                {{else}}
                  <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Group</span>
                {{/if}}
              </td>

              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="/admin/categories/{{this.id}}/edit" data-bs-toggle="tooltip" data-bs-title="Edit this category">
                  <i class="bi bi-pencil-square"></i> Edit
                </a>

                <form action="/admin/categories/{{this.id}}/delete"
                      method="post" class="d-inline"
                      onsubmit="return confirm('Delete category {{this.name}}?');">
                  <button class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" data-bs-title="Delete">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </form>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>

      <!-- Footer: filter result count + pagination -->
      <div class="d-flex justify-content-between align-items-center mt-2 small text-muted">
        <div>
          <span id="filterCount" class="me-2">Showing {{categories.length}} items</span>
          <span class="d-none d-md-inline">Tip: type to filter by <em>name</em> or <em>slug</em>.</span>
        </div>

        {{#if pagination}}
          {{> pagination pagination}}
        {{else}}
          {{#if (and page totalPages)}}
            {{#with (buildPagination page totalPages "/admin/categories") as |p|}}
              <nav aria-label="Categories pagination">
                <ul class="pagination pagination-sm mb-0">
                  {{#if p.hasPrev}}<li class="page-item"><a class="page-link" href="{{p.prevUrl}}">Prev</a></li>{{/if}}
                  {{#each p.pages}}
                    <li class="page-item {{#if this.active}}active{{/if}}">
                      <a class="page-link" href="{{this.url}}">{{this.page}}</a>
                    </li>
                  {{/each}}
                  {{#if p.hasNext}}<li class="page-item"><a class="page-link" href="{{p.nextUrl}}">Next</a></li>{{/if}}
                </ul>
              </nav>
            {{/with}}
          {{/if}}
        {{/if}}
      </div>
    {{else}}
      <div class="card border-0 shadow-sm empty-enter">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-inboxes text-muted fs-4"></i>
            <div>Chưa có danh mục nào.</div>
          </div>
          <a class="btn btn-primary btn-glow" href="/admin/categories/new">
            <i class="bi bi-plus-circle me-1"></i> Create your first category
          </a>
        </div>
      </div>
    {{/if}}

    <!-- TOAST -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
      <div id="toastCopied" class="toast align-items-center text-white bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">Slug copied!</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* motion */
  @media (prefers-reduced-motion: no-preference) {
    .page-enter   { animation: fadeUp .45s ease-out both; }
    .header-enter { animation: fadeUp .5s .02s ease-out both; }
    .table-enter  { animation: fadeUp .55s .04s ease-out both; }
    .empty-enter  { animation: fadeUp .5s ease-out both; }
    .row-enter    { animation: fadeIn .25s ease-in both; }
  }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  .brand-dot{
    width:10px;height:10px;border-radius:50%;
    background:linear-gradient(135deg,#6ea8fe,#2ecc71);
    box-shadow:0 0 0 3px rgba(110,168,254,.15);
  }

  /* table polish */
  #tblCategories tbody tr:hover {
    background: rgba(13,110,253,.04);
    box-shadow: inset 0 0 0 9999px rgba(13,110,253,.03);
  }
  #tblCategories thead th {
    position: sticky; top: -1px;
    background: var(--bs-light);
    z-index: 2;
  }

  /* buttons glow */
  .btn-glow{ position:relative; transition:transform .12s ease }
  .btn-glow:hover{ transform: translateY(-1px) }
  .btn-glow::after{
    content:""; position:absolute; inset:-2px; border-radius:.6rem;
    background: radial-gradient(120px 60px at var(--x,50%) 120%, rgba(255,255,255,.25), transparent 60%);
    opacity:0; transition:opacity .2s ease; pointer-events:none;
  }
  .btn-glow:hover::after{ opacity:1 }

  /* highlight filter */
  mark.hl { padding:0; background: #fff3cd; }
</style>

<script>
  // ===== Bootstrap tooltips =====
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

  // ===== Copy slug + toast =====
  const toastEl = document.getElementById('toastCopied');
  const showCopied = () => toastEl && new bootstrap.Toast(toastEl).show();

  document.querySelectorAll('.btn-copy-slug').forEach(btn => {
    btn.addEventListener('click', async () => {
      const slug = btn.getAttribute('data-slug') || '';
      try {
        await navigator.clipboard.writeText(slug);
        showCopied();
        const old = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check2"></i>';
        setTimeout(() => (btn.innerHTML = old), 900);
      } catch {
        alert('Cannot copy to clipboard.');
      }
    });
  });

  // ===== Header glow pointer position =====
  document.addEventListener('pointermove', e => {
    document.querySelectorAll('.btn-glow').forEach(btn => {
      const r = btn.getBoundingClientRect();
      btn.style.setProperty('--x', `${((e.clientX - r.left) / r.width) * 100}%`);
    });
  });

  // ===== Quick filter (debounce + count + highlight) =====
  const $filter = document.getElementById('quickFilter');
  const $rows   = document.querySelectorAll('#tblCategories tbody tr');
  const $count  = document.getElementById('filterCount');

  // store originals for safe highlight toggling
  const originals = Array.from($rows).map(tr => {
    const nameEl = tr.querySelector('.cell-name');
    const slugEl = tr.querySelector('.cell-slug');
    const parentEl = tr.querySelector('.cell-parent');
    return {
      tr,
      nameEl,
      slugEl,
      parentEl,
      name: nameEl?.dataset.text || '',
      slug: slugEl?.dataset.text || '',
      parent: parentEl?.dataset.text || ''
    };
  });

  const escapeReg = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

  const highlight = (el, text, q) => {
    if (!el) return;
    if (!q) { el.innerHTML = el.dataset.text || text; return; }
    const safe = escapeReg(q);
    const re = new RegExp(`(${safe})`, 'ig');
    el.innerHTML = (text || '').replace(re, '<mark class="hl">$1</mark>');
  };

  const applyFilter = (q) => {
    q = (q || '').trim().toLowerCase();
    let visible = 0;
    originals.forEach(({ tr, nameEl, slugEl, parentEl, name, slug, parent }) => {
      const hit = !q || name.toLowerCase().includes(q) || slug.toLowerCase().includes(q);
      tr.style.display = hit ? '' : 'none';
      if (hit) {
        visible++;
        highlight(nameEl, name, q);
        highlight(slugEl, slug, q);
        if (parentEl) highlight(parentEl, parent, q);
      } else {
        if (nameEl) nameEl.innerHTML = name;
        if (slugEl) slugEl.innerHTML = slug;
        if (parentEl) parentEl.innerHTML = parent || '<span class="badge bg-secondary">None</span>';
      }
    });
    if ($count) $count.textContent = `Showing ${visible} item${visible!==1?'s':''}`;
  };

  // debounce
  let t;
  $filter?.addEventListener('input', (e) => {
    clearTimeout(t);
    t = setTimeout(() => applyFilter(e.target.value), 140);
  });

  // init count
  applyFilter('');
</script>
