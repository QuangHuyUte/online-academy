<style>
    .hover-shadow:hover {
        transform: translateY(-3px);
        transition: all 0.2s ease-in-out;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    .course-logo {
        position: absolute;
        z-index: 9999;
        /* ‚úÖ lu√¥n n·∫±m tr√™n header */
        background: white;
        padding: 4px;
        border-radius: 8px;
        /* ‚úÖ h√¨nh vu√¥ng bo nh·∫π */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.25s ease-in-out;
    }

    .course-logo img {
        display: block;
        border-radius: 6px;
        /* bo nh·∫π trong khung tr·∫Øng */
    }

    .course-logo:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
    }

    .course-header {
        background: linear-gradient(90deg, #003973 0%, #005AA7 100%);
        /* xanh navy -> blue gradient */
        width: 100vw;
        /* full m√†n h√¨nh ngang */
        margin-left: calc(-50vw + 50%);
        /* ƒë·∫©y ra kh·ªèi container */
        padding: 60px 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        color: white;
        position: relative;
        z-index: 1;
    }
</style>



<div class="container py-5">

    <!-- Header: Title + Rating -->
    <!-- üåà HEADER -->
    <!-- Logo HCMUTE g√≥c tr√°i -->


    <div class="position-absolute top-0 start-0" style="margin-top: 10px; margin-left: 15px;">
        <img src="https://hcmute.edu.vn/Resources/Images/Logo/Logo%20HCMUTE-Corel-white%20background.jpg" alt="HCMUTE"
            style="width: 75px; height: 75px; object-fit: cover;">
    </div>



    <div class="course-header mb-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="fw-bold">{{course.title}}</h1>
                    <p class="mb-3">{{course.short_desc}}</p>

                    <div class="d-flex align-items-center flex-wrap">
                        <div class="text-warning me-2">
                            {{#each (range 1 6)}}
                            {{#ifCond @index '<=' ../course.rating_avg}}‚òÖ{{else}}‚òÜ{{/ifCond}} {{/each}} </div>
                                <span class="fw-bold me-2">{{course.rating_avg}}/5</span>
                                <span>({{course.rating_count}} ƒë√°nh gi√°)</span>
                                <span class="mx-2">|</span>
                                <span>{{course.students_count}} h·ªçc vi√™n</span>
                        </div>

                        <p class="mt-2">
                            <i class="bi bi-clock-history"></i> C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:
                            {{formatDate course.last_updated_at}}
                        </p>
                    </div>

                    <div class="col-md-4 text-center">
                        {{#if course.preview_video}}
                        <iframe width="100%" height="230" src="{{course.preview_video}}" title="{{course.title}}"
                            allowfullscreen></iframe>
                        {{else}}
                        <img src="{{course.cover_url}}" alt="{{course.title}}" class="img-fluid rounded shadow">
                        {{/if}}
                        <h4 class="text-warning fw-bold mt-3">{{course.promo_price}}‚Ç´</h4>
                        <p class="text-decoration-line-through text-light small">{{course.price}}‚Ç´</p>
                        <button class="btn btn-light text-primary fw-bold px-4 py-2 mt-2 w-75">
                            <i class="bi bi-cart-plus"></i> ƒêƒÉng k√Ω h·ªçc
                        </button>
                        <form id="watchlistForm" class="mt-3">
                            <input type="hidden" id="courseId" value="{{course.id}}">
                            <button type="submit" id="watchlistBtn"
                                class="btn {{#if inWatchlist}}btn-danger{{else}}btn-outline-danger{{/if}} w-75">
                                <i class="bi {{#if inWatchlist}}bi-heart-fill{{else}}bi-heart{{/if}}"></i>
                                {{#if inWatchlist}}ƒê√£ y√™u th√≠ch{{else}}Th√™m v√†o y√™u th√≠ch{{/if}}
                            </button>
                        </form>

                        <script>
                            document.getElementById('watchlistForm').addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const btn = document.getElementById('watchlistBtn');
                                const courseId = document.getElementById('courseId').value;
                                const isAdded = btn.classList.contains('btn-danger');
                                const url = isAdded ? '/courses/watchlist/remove' : '/courses/watchlist/add';

                                const res = await fetch(url, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ course_id: courseId })
                                });
                                const result = await res.json();

                                if (result.success) {
                                    alert(result.message);
                                    btn.classList.toggle('btn-danger');
                                    btn.classList.toggle('btn-outline-danger');
                                    const icon = btn.querySelector('i');
                                    if (isAdded) {
                                        icon.classList.replace('bi-heart-fill', 'bi-heart');
                                        btn.innerHTML = '<i class="bi bi-heart"></i> Th√™m v√†o y√™u th√≠ch';
                                    } else {
                                        icon.classList.replace('bi-heart', 'bi-heart-fill');
                                        btn.innerHTML = '<i class="bi bi-heart-fill"></i> ƒê√£ y√™u th√≠ch';
                                    }
                                }
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>


        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mt-4" id="courseTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                    type="button" role="tab">T·ªïng quan</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="outline-tab" data-bs-toggle="tab" data-bs-target="#outline" type="button"
                    role="tab">ƒê·ªÅ c∆∞∆°ng</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button"
                    role="tab">ƒê√°nh gi√°</button>
            </li>
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content p-4 border border-top-0 rounded-bottom">
            <!-- T·ªïng quan -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                {{{course.long_desc_html}}}
            </div>

            <!-- ƒê·ªÅ c∆∞∆°ng -->
            <div class="tab-pane fade" id="outline" role="tabpanel">
                {{#if outlineEmpty}}
                <p class="text-muted">Ch∆∞a c√≥ n·ªôi dung ƒë·ªÅ c∆∞∆°ng.</p>
                {{else}}
                {{#each outline}}
                <!-- Section -->
                <div class="mb-4">
                    <h5 class="fw-bold text-primary mt-3">
                        <i class="bi bi-journal-text me-2"></i> {{title}}
                    </h5>

                    <ul class="list-group mb-3">
                        {{#each lessons}}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-play-btn text-danger me-2"></i>
                                <span class="fw-semibold">{{title}}</span>

                                {{#if duration_sec}}
                                <small class="text-muted ms-2">‚è± {{duration_sec}}s</small>
                                {{/if}}
                            </div>

                            {{#if is_preview}}
                            <a href="{{video_url}}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-play-circle"></i> Xem th·ª≠
                            </a>
                            {{/if}}
                        </li>
                        {{/each}}
                    </ul>
                </div>
                {{/each}}
                {{/if}}
            </div>




            <!-- ƒê√°nh gi√° -->
            <div class="tab-pane fade" id="reviews" role="tabpanel">
                {{#if hasReviews}}
                {{#each reviews}}
                <div class="border-bottom pb-3 mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <strong class="me-2">{{user_name}}</strong>
                        <div class="text-warning">
                            {{#each (range 1 6)}}
                            {{#ifCond this '<=' ../rating}}‚òÖ{{else}}‚òÜ{{/ifCond}} {{/each}} </div>
                        </div>
                        <p>{{comment}}</p>
                        <small class="text-muted">G·ª≠i ng√†y {{formatDate created_at}}</small>
                    </div>
                    {{/each}}
                    {{else}}
                    <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho kh√≥a h·ªçc n√†y.</p>
                    {{/if}}

                    <hr class="my-4">

                    <!-- Form g·ª≠i ƒë√°nh gi√° -->
                    <h5 class="fw-bold mb-3">G·ª≠i ƒë√°nh gi√° c·ªßa b·∫°n</h5>
                    <form id="reviewForm">
                        <input type="hidden" id="courseId" value="{{course.id}}">
                        <div class="mb-3">
                            <label class="form-label">Ch·ªçn s·ªë sao:</label>
                            <select class="form-select w-auto" id="rating" required>
                                <option value="">-- Ch·ªçn --</option>
                                <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                                <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</option>
                                <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</option>
                                <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</option>
                                <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nh·∫≠n x√©t:</label>
                            <textarea class="form-control" id="comment" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> G·ª≠i ƒë√°nh gi√°
                        </button>
                    </form>
                </div>

                <script>
                    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const courseId = document.getElementById('courseId').value;
                        const rating = document.getElementById('rating').value;
                        const comment = document.getElementById('comment').value;

                        const res = await fetch('/courses/details/review', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ course_id: courseId, rating, comment })
                        });
                        const result = await res.json();
                        alert(result.message);
                        if (result.success) location.reload();
                    });
                </script>

                <!-- Gi·∫£ng vi√™n -->
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <img src="{{course.instructor_avatar}}" alt="{{course.instructor_name}}"
                            class="rounded-circle img-fluid shadow-sm"
                            style="width: 100px; height: 100px; object-fit: cover;">
                    </div>
                    <div class="col-md-10">
                        <h5 class="fw-bold">{{course.instructor_name}}</h5>
                        <p class="text-muted mb-1">{{course.instructor_bio}}</p>
                        <small class="text-secondary">Gi·∫£ng vi√™n chuy√™n ng√†nh ‚Ä¢ {{course.category_name}}</small>
                    </div>
                </div>

                <hr class="my-5">

                <!-- Kh√≥a h·ªçc c√πng lƒ©nh v·ª±c -->
                <section class="mt-5">
                    <h4 class="fw-bold mb-4 text-primary">
                        <i class="bi bi-bar-chart-line-fill text-warning me-2"></i>
                        Top 5 kh√≥a h·ªçc c√πng lƒ©nh v·ª±c ƒë∆∞·ª£c mua nhi·ªÅu nh·∫•t
                    </h4>

                    {{#if related.length}}
                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        {{#each related}}
                        <div class="col">
                            <div class="card h-100 shadow-sm border-0 hover-shadow">
                                <img src="{{cover_url}}" class="card-img-top" alt="{{title}}"
                                    style="height: 180px; object-fit: cover; border-top-left-radius: .5rem; border-top-right-radius: .5rem;">

                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title fw-bold text-truncate" title="{{title}}">
                                        <a href="/courses/details?id={{id}}" class="text-dark text-decoration-none">
                                            {{title}}
                                        </a>
                                    </h6>

                                    <p class="text-muted small mb-1">
                                        <i class="bi bi-person-circle me-1"></i>{{instructor_name}}
                                    </p>

                                    <p class="text-warning mb-2">
                                        ‚òÖ {{rating_avg}}
                                        <small class="text-muted">({{rating_count}} ƒë√°nh gi√°)</small>
                                    </p>

                                    <div class="mt-auto d-flex justify-content-between align-items-center">
                                        {{#if promo_price}}
                                        <span class="fw-bold text-danger">{{promo_price}} ‚Ç´</span>
                                        <small class="text-decoration-line-through text-secondary">{{price}} ‚Ç´</small>
                                        {{else}}
                                        <span class="fw-bold text-dark">{{price}} ‚Ç´</span>
                                        {{/if}}
                                    </div>
                                </div>

                                <div class="card-footer bg-white border-top-0">
                                    <a href="/courses/details?id={{id}}" class="btn btn-outline-primary w-100 btn-sm">
                                        <i class="bi bi-eye"></i> Xem chi ti·∫øt
                                    </a>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    {{else}}
                    <p class="text-muted">Kh√¥ng c√≥ kh√≥a h·ªçc n√†o kh√°c trong c√πng lƒ©nh v·ª±c.</p>
                    {{/if}}
                </section>
            </div>