<main class="container-fluid py-0">
  <div class="row g-0">
    <!-- ======= VIDEO PLAYER B√äN TR√ÅI ======= -->
    <div class="col-12 col-lg-8">
      <div class="player-wrapper">
        <!-- üé¨ Plyr video player -->
        <video id="player" playsinline controls></video>

        <!-- Placeholder khi ch∆∞a ch·ªçn b√†i -->
        <div id="placeholder" class="player-placeholder">
          <img src="https://cdn-icons-png.flaticon.com/512/2920/2920244.png" alt="No video selected" width="120" />
          <p class="text-muted mt-2">Ch·ªçn m·ªôt b√†i h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu xem video</p>
        </div>
      </div>
    </div>

    <!-- ======= DANH S√ÅCH B√ÄI H·ªåC ======= -->
    <div class="col-12 col-lg-4 px-4 py-3">
      <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
        <div class="card-body">
          <h5 class="fw-bold mb-3 text-primary">
            <i class="bi bi-collection-play"></i> Danh s√°ch b√†i gi·∫£ng
          </h5>

          {{#each sections}}
            <div class="mb-3">
              <h6 class="fw-semibold text-secondary">{{title}}</h6>
              <ul class="list-group list-group-flush">
                {{#each lessons}}
                  <li class="list-group-item p-2">
                    <button
                      id="lesson-{{id}}"
                      class="btn btn-link text-decoration-none w-100 text-start lesson-item"
                      onclick="loadVideo('{{video_url}}','{{id}}')"
                    >
                      ‚ñ∂ {{title}}
                    </button>
                  </li>
                {{/each}}
              </ul>
            </div>
          {{/each}}
        </div>
      </div>
    </div>
  </div>
</main>

<!-- ‚úÖ Plyr CDN -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
  let player;
  let lastSent = 0;

  document.addEventListener("DOMContentLoaded", () => {
    player = new Plyr("#player", { ratio: "16:9" });

    // Ghi nh·∫≠n th·ªùi gian xem (m·ªói 10s)
    player.on("timeupdate", () => {
      const lessonId = window.currentLessonId;
      if (!lessonId || !player.duration) return;

      const current = Math.floor(player.currentTime);
      const duration = Math.floor(player.duration);
      if (current - lastSent >= 10) { // m·ªói 10 gi√¢y g·ª≠i 1 l·∫ßn
        lastSent = current;

        const isDone = current / duration >= 0.9; // n·∫øu xem ‚â•90%
        sendProgress(lessonId, current, isDone);
      }
    });

    // Khi video k·∫øt th√∫c ‚Üí ƒë√°nh d·∫•u ho√†n th√†nh
    player.on("ended", () => {
      const lessonId = window.currentLessonId;
      if (!lessonId) return;
      sendProgress(lessonId, Math.floor(player.duration), true);
      console.log("‚úÖ Ho√†n th√†nh b√†i h·ªçc:", lessonId);
    });
  });

  function loadVideo(url, lessonId) {
    const videoId = extractYouTubeId(url);
    window.currentLessonId = lessonId;
    lastSent = 0;

    if (!videoId) {
      alert("‚ùå URL video kh√¥ng h·ª£p l·ªá!");
      return;
    }

    // ·∫®n placeholder v√† hi·ªÉn th·ªã video
    document.getElementById("placeholder").style.display = "none";

    player.source = {
      type: "video",
      sources: [{ src: videoId, provider: "youtube" }],
    };

    // Highlight b√†i h·ªçc ƒëang h·ªçc
    document.querySelectorAll(".lesson-item").forEach(btn =>
      btn.classList.remove("active-lesson")
    );
    document.getElementById(`lesson-${lessonId}`)?.classList.add("active-lesson");
  }

  // G·ª≠i ti·∫øn ƒë·ªô l√™n server
  function sendProgress(lessonId, watchedSec, isDone) {
    fetch(`/student/progress/${lessonId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ watched_sec: watchedSec, is_done: isDone }),
    }).catch(console.error);
  }

  function extractYouTubeId(url) {
    const regex = /(?:youtube\.com\/(?:.*v=|embed\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
    const match = url?.match(regex);
    return match ? match[1] : null;
  }
</script>



<style>
  body {
    background-color: #f8f9fa;
  }

  /* ======= KHUNG VIDEO ======= */
  .player-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .player-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: #f8f9fa;
    color: #666;
  }

  .lesson-item {
    color: #0d6efd;
    font-weight: 500;
    border-radius: 6px;
  }

  .lesson-item.active-lesson {
    background-color: #0d6efd !important;
    color: #fff;
    font-weight: 700;
  }

  .lesson-item:hover {
    background-color: #eef4ff;
    color: #0a58ca;
  }

  .card {
    border-radius: 0.75rem;
  }

  @media (max-width: 991px) {
    .player-wrapper {
      margin-bottom: 1.5rem;
    }
  }
</style>
