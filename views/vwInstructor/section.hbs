<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Course Content</h3>
      <div class="text-muted">#{{course.id}} — {{course.title}}</div>
    </div>
    <div class="d-flex gap-2">
      <a href="/instructor/my-courses" class="btn btn-outline-secondary">Back</a>
      {{#unless course.is_completed}}
        <form action="/instructor/courses/{{course.id}}/complete" method="post"
              onsubmit="return confirm('Mark this course as completed?');">
          <button class="btn btn-success">Mark Completed</button>
        </form>
      {{/unless}}
    </div>
  </div>

  {{> flash}}

  <div class="card mb-4">
    <div class="card-header fw-semibold">Add Section</div>
    <div class="card-body">
      <form method="post" action="/instructor/sections">
        <input type="hidden" name="course_id" value="{{course.id}}">
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <label class="form-label">Title</label>
            <input name="title" class="form-control" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Order</label>
            <input name="order_no" type="number" class="form-control" min="1" value="1">
          </div>
          <div class="col-md-4 text-end">
            <button class="btn btn-primary">Add Section</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {{#if sections.length}}
    <div class="accordion" id="accSections">
      {{#each sections}}
        <div class="accordion-item">
          <h2 class="accordion-header" id="h{{this.id}}">
            <button
              class="accordion-button {{#unless @first}}collapsed{{/unless}}"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#c{{this.id}}"
              aria-expanded="{{#if @first}}true{{else}}false{{/if}}"
            >
              <strong class="me-2">#{{this.order_no}}</strong> {{this.title}}
            </button>
          </h2>
          <div
            id="c{{this.id}}"
            class="accordion-collapse collapse {{#if @first}}show{{/if}}"
            data-bs-parent="#accSections"
          >
            <div class="accordion-body">

              <div class="d-flex justify-content-between align-items-center mb-3">
                <form class="row g-2" method="post" action="/instructor/sections/{{this.id}}">
                  <div class="col-md-6">
                    <label class="form-label">Title</label>
                    <input name="title" class="form-control" value="{{this.title}}" required>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Order</label>
                    <input name="order_no" type="number" class="form-control" min="1" value="{{this.order_no}}">
                  </div>
                  <div class="col-md-4 text-end">
                    <button class="btn btn-outline-primary">Save</button>
                  </div>
                </form>

                <form method="post" action="/instructor/sections/{{this.id}}/delete"
                      onsubmit="return confirm('Delete this section (no lessons)?');">
                  <button class="btn btn-outline-danger">Delete</button>
                </form>
              </div>

              {{!-- Lessons table --}}
              <div class="table-responsive mb-3">
                <table class="table table-sm table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width:60px">#</th>
                      <th>Title</th>
                      <th>Video URL</th>
                      <th style="width:120px">Duration</th>
                      <th style="width:120px">Preview</th>
                      <th style="width:220px" class="text-end">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#if this.lessons.length}}
                      {{#each this.lessons}}
                        <tr>
                          <td>{{inc @index}}</td>
                          <td class="text-truncate" style="max-width:300px;">{{this.title}}</td>
                          <td class="text-truncate" style="max-width:360px;">
                            <a href="{{this.video_url}}" target="_blank">{{this.video_url}}</a>
                          </td>
                          <td>{{#if this.duration_sec}}{{this.duration_sec}}s{{else}}—{{/if}}</td>
                          <td>{{#if this.is_preview}}Yes{{else}}No{{/if}}</td>
                          <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#editL{{this.id}}">
                              Edit
                            </button>
                            <form method="post" action="/instructor/lessons/{{this.id}}/delete"
                                  class="d-inline"
                                  onsubmit="return confirm('Delete this lesson?');">
                              <button class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                          </td>
                        </tr>
                        <tr class="collapse" id="editL{{this.id}}">
                          <td colspan="6">
                            <form class="row g-2 align-items-end" method="post" action="/instructor/lessons/{{this.id}}">
                              <div class="col-md-4">
                                <label class="form-label">Title</label>
                                <input name="title" class="form-control" value="{{this.title}}" required>
                              </div>
                              <div class="col-md-4">
                                <label class="form-label">Video URL</label>
                                <div class="input-group">
                                  <input name="video_url"
                                         class="form-control"
                                         value="{{this.video_url}}"
                                         required
                                         pattern="^\/uploads\/.+"
                                         title="Dùng URL trả về từ nút Upload (bắt đầu bằng /uploads/...)">
                                  <button class="btn btn-outline-secondary btn-upload" type="button">Upload</button>
                                </div>
                              </div>
                              <div class="col-md-2">
                                <label class="form-label">Duration (s)</label>
                                <input name="duration_sec" type="number" min="0" class="form-control" value="{{this.duration_sec}}">
                              </div>
                              <div class="col-md-1 form-check mt-4">
                                <input class="form-check-input" type="checkbox" name="is_preview" {{#if this.is_preview}}checked{{/if}}>
                                <label class="form-check-label">Preview</label>
                              </div>
                              <div class="col-md-1">
                                <label class="form-label">Ord</label>
                                <input name="order_no" type="number" min="1" class="form-control" value="{{this.order_no}}">
                              </div>
                              <div class="col-12 text-end">
                                <button class="btn btn-primary">Save Lesson</button>
                              </div>
                            </form>
                          </td>
                        </tr>
                      {{/each}}
                    {{else}}
                      <tr><td colspan="6" class="text-muted">Chưa có bài học nào trong section này.</td></tr>
                    {{/if}}
                  </tbody>
                </table>
              </div>

              {{!-- Add Lesson --}}
              <div class="card">
                <div class="card-header fw-semibold">Add Lesson</div>
                <div class="card-body">
                  <form class="row g-2 align-items-end" method="post" action="/instructor/lessons">
                    <input type="hidden" name="section_id" value="{{this.id}}">
                    <div class="col-md-4">
                      <label class="form-label">Title</label>
                      <input name="title" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Video URL</label>
                      <div class="input-group">
                        <input name="video_url"
                               class="form-control"
                               placeholder="/uploads/..."
                               required
                               pattern="^\/uploads\/.+"
                               title="Dùng URL trả về từ nút Upload (bắt đầu bằng /uploads/...)">
                        <button class="btn btn-outline-secondary btn-upload" type="button">Upload</button>
                      </div>
                      <div class="form-text">Chọn file mp4/webm/ogg. Hệ thống sẽ upload và tự điền URL.</div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Duration (s)</label>
                      <input name="duration_sec" type="number" min="0" class="form-control">
                    </div>
                    <div class="col-md-1 form-check mt-4">
                      <input class="form-check-input" type="checkbox" name="is_preview">
                      <label class="form-check-label">Preview</label>
                    </div>
                    <div class="col-md-1">
                      <label class="form-label">Ord</label>
                      <input name="order_no" type="number" min="1" class="form-control" value="1">
                    </div>
                    <div class="col-12 text-end">
                      <button class="btn btn-primary">Add Lesson</button>
                    </div>
                  </form>
                </div>
              </div>

            </div> <!-- accordion-body -->
          </div>
        </div>
      {{/each}}
    </div>
  {{else}}
    <div class="alert alert-info">Khoá học chưa có section nào — hãy thêm Section đầu tiên.</div>
  {{/if}}
</div>

<script>
  // Upload video bằng Multer API
  document.querySelectorAll('.btn-upload').forEach(btn => {
    btn.addEventListener('click', async () => {
      const input = btn.closest('.input-group')?.querySelector('input[name="video_url"]');
      if (!input) return;

      const picker = document.createElement('input');
      picker.type = 'file';
      picker.accept = 'video/mp4,video/webm,video/ogg';
      picker.onchange = async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const form = new FormData();
        form.append('file', f, f.name);
        try {
          const res = await fetch('/instructor/upload', { method: 'POST', body: form });
          if (!res.ok) throw new Error('Upload failed: ' + res.status);
          const data = await res.json();
          if (!data?.url) throw new Error('Invalid upload response');
          input.value = data.url;
        } catch (err) {
          alert(err.message || 'Upload error');
        }
      };
      picker.click();
    });
  });

  // Double-submit guard + fix order/duration
  document.querySelectorAll('form').forEach(f => {
    f.addEventListener('submit', e => {
      const ord = f.querySelector('input[name="order_no"]');
      const dur = f.querySelector('input[name="duration_sec"]');
      if (ord) ord.value = Math.max(1, Number(ord.value || 1));
      if (dur && dur.value !== '') dur.value = Math.max(0, Number(dur.value || 0));
      const btn = f.querySelector('button[type="submit"], button:not([type])');
      btn && (btn.disabled = true);
    });
  });
</script>
