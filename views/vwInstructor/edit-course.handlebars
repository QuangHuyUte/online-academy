<form id="frmCourse" method="post" action="{{#if course.id}}/instructor/courses/{{course.id}}{{else}}/instructor/courses{{/if}}">
  <div class="row g-4">
    <!-- LEFT: Course Info -->
    <div class="col-md-12">
      <div class="mb-3">
        <label class="form-label fw-semibold">Title <span class="text-danger">*</span></label>
        <input name="title" class="form-control" value="{{course.title}}" required>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Short Description</label>
        <textarea name="short_desc" class="form-control" rows="3">{{course.short_desc}}</textarea>
      </div>

      <!-- Quill Editor -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Full Description</label>
        <div id="editor" style="height: 500px; background: #fff; border: 1px solid #ccc; border-radius: 8px;">
          {{{course.long_desc_html}}}
        </div>
        <textarea id="long_desc_html" name="long_desc_html" hidden>{{{course.long_desc_html}}}</textarea>
      </div>
    </div>

    <!-- RIGHT: Metadata -->
    <div class="col-md-6 col-lg-5">
      <div class="mb-3">
        <label class="form-label fw-semibold">Category <span class="text-danger">*</span></label>
        <select name="cat_id" class="form-select" required>
          <option value="">-- Select category --</option>
          {{#each categories}}
            <option 
              value="{{this.id}}" 
              {{#if (eq this.id ../course.cat_id)}}selected{{/if}}
              {{#unless this.parent_id}}disabled{{/unless}}>
              {{#unless this.parent_id}}[Group] {{/unless}}{{this.name}}
            </option>
          {{/each}}
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Price</label>
        <input name="price" type="number" step="0.01" min="0" class="form-control" value="{{course.price}}">
        <div class="form-text">ƒê·ªÉ tr·ªëng n·∫øu mi·ªÖn ph√≠.</div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Promo Price</label>
        <input name="promo_price" type="number" step="0.01" min="0" class="form-control" value="{{course.promo_price}}">
        <div class="form-text">Kh√¥ng l·ªõn h∆°n Price.</div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Cover Image</label>
        <div class="d-flex align-items-center gap-3">
          <img id="coverPreview" src="{{course.cover_url}}" alt="" class="rounded border" 
               style="width:120px;height:120px;object-fit:cover;{{#unless course.cover_url}}display:none;{{/unless}}">
          <div>
            <input id="coverFile" type="file" accept="image/*" class="form-control form-control-sm" />
            <input type="hidden" name="cover_url" id="coverUrl" value="{{course.cover_url}}">
            <div class="form-text">·∫¢nh s·∫Ω ƒë∆∞·ª£c upload v√† t·ª± g√°n v√†o Cover URL.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-4">

  <div class="d-flex justify-content-between align-items-center">
    <a href="/instructor/my-course" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Cancel
    </a>
    <button id="btnSubmit" class="btn btn-primary px-4" type="submit">
      {{#if course.id}}Update{{else}}Create{{/if}}
    </button>
  </div>
</form>


<!-- Quill CSS + JS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
/* ==========================================================
   üîπ Quill Editor Setup (MIT License, Free)
========================================================== */
const quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: 'Nh·∫≠p m√¥ t·∫£ chi ti·∫øt kh√≥a h·ªçc...',
  modules: {
    toolbar: [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ color: [] }, { background: [] }],
      [{ align: [] }],
      [{ list: 'ordered' }, { list: 'bullet' }],
      ['link', 'image', 'video'],
      ['clean']
    ]
  }
});

// --- Sync content to hidden textarea before submit ---
document.querySelector('#frmCourse')?.addEventListener('submit', (e) => {
  document.querySelector('#long_desc_html').value = quill.root.innerHTML;
});

// --- Custom image upload handler ---
function selectLocalImage() {
  const input = document.createElement('input');
  input.setAttribute('type', 'file');
  input.setAttribute('accept', 'image/*');
  input.click();

  input.onchange = async () => {
    const file = input.files[0];
    if (!file) return;
    const form = new FormData();
    form.append('file', file, file.name);
    try {
      const res = await fetch('/instructor/upload', { method: 'POST', body: form });
      if (!res.ok) throw new Error('Upload failed: ' + res.status);
      const data = await res.json();
      if (!data?.url) throw new Error('Invalid upload response');
      const range = quill.getSelection();
      quill.insertEmbed(range.index, 'image', data.url);
    } catch (err) {
      alert(err.message || 'Upload error');
    }
  };
}
quill.getModule('toolbar').addHandler('image', selectLocalImage);


/* ==========================================================
   üîπ Cover Upload (Preview)
========================================================== */
const $file = document.getElementById('coverFile');
const $url  = document.getElementById('coverUrl');
const $img  = document.getElementById('coverPreview');

$file?.addEventListener('change', async (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  const form = new FormData();
  form.append('file', f, f.name);
  try {
    const res = await fetch('/instructor/upload', { method: 'POST', body: form });
    if (!res.ok) throw new Error('Upload failed: ' + res.status);
    const data = await res.json();
    if (!data?.url) throw new Error('Invalid upload response');
    $url.value = data.url;
    $img.src = data.url;
    $img.style.display = '';
  } catch (err) {
    alert(err.message || 'Upload error');
  } finally {
    e.target.value = '';
  }
});


/* ==========================================================
   üîπ Validate + ch·ªëng double submit
========================================================== */
document.getElementById('frmCourse')?.addEventListener('submit', (e) => {
  const price = parseFloat(document.querySelector('[name="price"]')?.value || '');
  const promo = parseFloat(document.querySelector('[name="promo_price"]')?.value || '');
  const catId = document.querySelector('[name="cat_id"]')?.value;

  if (!catId) {
    e.preventDefault();
    return alert('Vui l√≤ng ch·ªçn Category.');
  }
  if (!isNaN(promo) && !isNaN(price) && promo > price) {
    e.preventDefault();
    return alert('Promo Price kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n Price.');
  }

  // ƒê·ªìng b·ªô l·∫°i n·ªôi dung Quill
  document.querySelector('#long_desc_html').value = quill.root.innerHTML;

  // Ch·ªëng double-submit
  const btn = document.getElementById('btnSubmit');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
  }
});
</script>
